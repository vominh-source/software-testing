name: API Tests CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Step 3: Install backend dependencies
      - name: Install backend dependencies
        run: |
          cd sprint5-with-bugs
          npm install

      # Step 4: Start backend server with Docker Compose and wait
      - name: Start backend and wait for service
        run: |
          docker compose -f docker-compose.yml up -d
          npm install -g wait-on
          npx wait-on http://localhost:8091
          echo "Backend is ready"

      # Step 5: Check backend health
      - name: Test backend health
        run: |
          curl -f http://localhost:8091/status || (echo "Backend not ready" && exit 1)

      # Step 6: Install Newman
      - name: Install Newman
        run: npm install -g newman

      # Step 7: Run Sign In API Tests with JSON data
      - name: Run Sign In API Tests
        run: |
          newman run tests/HW7-SignIn.postman_collection.json \
            --iteration-data tests/data/signin_data.json \
            --reporters cli,junit \
            --reporter-cli-no-banner \
            --reporter-junit-export results.xml

      # Step 8: List files for debugging
      - name: List files after test
        run: ls -lah

      # Step 9: Upload test report
      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: api-test-report
          path: results.xml

      # Step 10: Show Docker logs on failure
      - name: Show Docker logs
        if: failure()
        run: docker compose logs

      # Step 11: Shutdown Docker Compose
      - name: Shutdown Docker Compose
        if: always()
        run: docker compose down -v
